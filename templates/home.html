{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>💰 Finans Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans flex">


  {% if messages %}
  <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; width: 320px;">
    {% for message in messages %}
      <div 
        class="shadow-lg rounded-xl mb-3 text-white d-flex align-items-center" 
        style="
          padding: 12px 16px;
          {% if message.tags == 'success' %} background:#28a745; 
          {% elif message.tags == 'error' %} background:#dc3545; 
          {% elif message.tags == 'warning' %} background:#ffc107; color:#222;
          {% else %} background:#007bff;
          {% endif %}
        ">
        {% if message.tags == "success" %}
          ✅
        {% elif message.tags == "error" %}
          ❌
        {% elif message.tags == "warning" %}
          ⚠️
        {% else %}
          ℹ️
        {% endif %}
        <span class="ms-2">{{ message }}</span>
      </div>
    {% endfor %}
  </div>
{% endif %}

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-800 h-screen shadow-lg flex flex-col">
    <div class="p-4 text-center text-indigo-400 text-2xl font-bold border-b border-gray-700">
      {% trans "Menyu" %}
    </div>
    <nav class="flex-1 p-4">
      <ul class="space-y-2">
        <li><a href="{% url 'dashboard' %}" class="flex items-center p-2 rounded hover:bg-gray-700">
          🏠 <span class="ml-2">{% trans "Bosh sahifa" %}</span>
        </a></li>
        <li><a href="{% url 'income' %}" class="flex items-center p-2 rounded hover:bg-gray-700">
          📈 <span class="ml-2">{% trans "Bugungi Kirim" %}</span>
        </a></li>
        <li><a href="{% url 'expence' %}" class="flex items-center p-2 rounded hover:bg-gray-700">
          📉 <span class="ml-2">{% trans "Bugungi Chiqim" %}</span>
        </a></li>
        <li><a href="{% url 'balance' %}" class="flex items-center p-2 rounded hover:bg-gray-700">
          💳 <span class="ml-2">{% trans "Joriy Balans" %}</span>
        </a></li>
        <li><a href="{% url 'sozlama' %}" class="flex items-center p-2 rounded hover:bg-gray-700">
          ⚙️ <span class="ml-2">{% trans "Sozlamalar" %}</span>
        </a></li>
      </ul>
    </nav>
    <div class="p-4 border-t border-gray-700">
      <a href="{% url "logout" %}" class="flex items-center p-2 rounded hover:bg-gray-700 text-red-400">
        🚪 <span class="ml-2">{% trans "Chiqish" %}</span>
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col">

    <!-- Navbar -->
    <nav class="bg-gray-800 shadow-md p-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-indigo-400 flex items-center space-x-2">
        <span>💰</span><span>Finans Dashboard</span>
      </h1>
      <div class="flex items-center space-x-4">
        <span class="text-gray-300">👋 {% trans "Salom," %} {{ request.user.username }}</span>
        <img src="https://i.pravatar.cc/40" class="w-10 h-10 rounded-full border-2 border-indigo-400" alt="profile">
      </div>
    </nav>

    <!-- Language Switch -->
    <form action="{% url 'set_language' %}" method="post" class="p-4 bg-gray-800 flex justify-end">
      {% csrf_token %}
      <select name="language" onchange="this.form.submit()" class="bg-gray-700 text-gray-200 rounded-lg px-3 py-1">
        <option value="uz-latn">🇺🇿 Uzbek</option>
        <option value="ru">🇷🇺 Русский</option>
        <option value="en">🇬🇧 English</option>
      </select>
    </form>

    <!-- Content -->
    <div class="p-6 overflow-y-auto flex-1">
      <!-- Stat cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-gray-800 rounded-xl shadow p-4 flex flex-col items-start">
          <p class="text-gray-400">📈 {% trans "Bugungi Kirim" %}</p>
          <h2 class="text-2xl font-bold text-green-400">
            +{{ total_income|floatformat:0 }} {{ currency }}
          </h2>
        </div>
        <div class="bg-gray-800 rounded-xl shadow p-4 flex flex-col items-start">
          <p class="text-gray-400">📉 {% trans "Bugungi Chiqim" %}</p>
          <h2 class="text-2xl font-bold text-red-400">
            -{{ total_expense|floatformat:0 }} {{ currency }}
          </h2>
        </div>
        <div class="bg-gray-800 rounded-xl shadow p-4 flex flex-col items-start">
          <p class="text-gray-400">💳 {% trans "Joriy Balans" %}</p>
          <h2 class="text-2xl font-bold text-indigo-400">
            {{ current_balance|floatformat:0 }} {{ currency }}
          </h2>
        </div>
        <div class="bg-gray-800 rounded-xl shadow p-4 flex flex-col items-start">
          <p class="text-gray-400">🔄 {% trans "Umumiy Tranzaksiya" %}</p>
          <h2 class="text-2xl font-bold text-yellow-400">
            {{ recent_transactions|length }} ta
          </h2>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-gray-800 rounded-xl shadow p-4">
          <h3 class="font-semibold text-gray-200 mb-4">📊 {% trans "Oylik Trend" %}</h3>
          <canvas id="lineChart"></canvas>
        </div>
        <div class="bg-gray-800 rounded-xl shadow p-4">
          <h3 class="font-semibold text-gray-200 mb-4">📂 {% trans "Kategoriya Bo‘yicha chiqimlar" %}</h3>
          <canvas id="donutChart"></canvas>
        </div>
      </div>

      <!-- Recent Transactions -->
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-700 text-gray-300">
            <th class="p-2">📅 Sana</th>
            <th class="p-2">📂 Kategoriya</th>
            <th class="p-2">💲 Summa</th>
            <th class="p-2">📝 Izoh</th>
          </tr>
        </thead>
        <tbody>
          {% for t in recent_transactions %}
          <tr class="border-b border-gray-700">
            <td class="p-2">{{ t.date|date:"Y-m-d H:i" }}</td>
            <td class="p-2">{{ t.category }}</td>
            <td class="p-2 {% if t.type == 'income' %}text-green-400{% else %}text-red-400{% endif %}">
              {% if t.type == 'income' %}+{% else %}-{% endif %}{{ t.amount|floatformat:0 }} {{ currency }}
            </td>
            <td class="p-2">{{ t.note }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4">Hech qanday tranzaksiya mavjud emas</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
  </div>

  <!-- Charts Scripts -->
 <script>
  // Oylar
  const months = ["Yanvar","Fevral","Mart","Aprel","May","Iyun","Iyul","Avgust","Sentyabr","Oktyabr","Noyabr","Dekabr"];

  // Line chart uchun ma’lumotlar
  const incomeData = {{ income_by_month|safe }};
  const expenseData = {{ expense_by_month|safe }};

  new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: {
      labels: months,
      datasets: [
        {
          label: "Kirim",
          data: incomeData,
          borderColor: "lime",
          backgroundColor: "rgba(34,197,94,0.2)",
          fill: true,
          tension: 0.3
        },
        {
          label: "Chiqim",
          data: expenseData,
          borderColor: "red",
          backgroundColor: "rgba(239,68,68,0.2)",
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      plugins: { legend: { labels: { color: "white" } } },
      scales: {
        x: { ticks: { color: "white" }, grid: { color: "#444" } },
        y: { ticks: { color: "white" }, grid: { color: "#444" } }
      }
    }
  });

  // Donut chart (kategoriya bo‘yicha chiqimlar)
  new Chart(document.getElementById("donutChart"), {
    type: "doughnut",
    data: {
      labels: [{% for c in categories %}"{{ c.category__name }}",{% endfor %}],
      datasets: [
        {
          data: [{% for c in categories %}{{ c.total }},{% endfor %}],
          backgroundColor: ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#06b6d4", "#d946ef"]
        }
      ]
    },
    options: {
      plugins: { legend: { labels: { color: "white" } } }
    }
  });
</script>


</body>
</html>
